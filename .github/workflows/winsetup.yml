name: setup-windows-server

on: [push, workflow_dispatch]

jobs:
  setup-windows-server:
    runs-on: windows-latest

    steps:
      - name: Install Chocolatey
        run: |
          Write-Host "Checking for Chocolatey..."
          if (-Not (Test-Path "C:\ProgramData\Chocolatey")) {
            Set-ExecutionPolicy Bypass -Scope Process -Force
            [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
            Invoke-Expression ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
          } else {
            Write-Host "Chocolatey is already installed."
          }

      - name: Install AnyDesk Silently
        run: |
          choco install anydesk -y --force
          Start-Sleep -Seconds 10
          Write-Host "AnyDesk Installed Successfully."

      - name: Get AnyDesk ID
        id: anydesk_id
        run: |
          $anydesk_id = (Get-Content "C:\ProgramData\AnyDesk\system.conf" | Select-String "ad.id=").ToString().Split('=')[1].Trim()
          Write-Host "AnyDesk ID: $anydesk_id"
          echo "ANYDESK_ID=$anydesk_id" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Set AnyDesk Unattended Access
        run: |
          echo mysecurepassword | "C:\Program Files (x86)\AnyDesk\AnyDesk.exe" --set-password
          Write-Host "Unattended Access Configured."

      - name: Display AnyDesk Connection Info
        run: |
          Write-Host "Use this AnyDesk ID to connect: $env:ANYDESK_ID"
          Write-Host "Password for connection: mysecurepassword"
