name: setup-windows-server

on: [push, pull_request]

jobs:
  setup-windows-server:
    runs-on: windows-latest

    steps:
      - name: Check out Repository
        uses: actions/checkout@v3

      - name: Verify Python Installation
        run: python --version
        shell: bash

      - name: Install RustDesk from Repo
        run: |
          $installerPath = "${{ github.workspace }}\rustdesk-1.3.8-x86_64.exe"
          $logPath = "${{ github.workspace }}\rustdesk_install.log"

          if (Test-Path $installerPath) {
            Write-Host "✅ RustDesk installer found! Installing..."
            Start-Process -FilePath $installerPath -ArgumentList "/VERYSILENT /SUPPRESSMSGBOXES /NORESTART /LOG=$logPath" -NoNewWindow -Wait
            Start-Sleep -Seconds 5
            
            if (Test-Path $logPath) {
              Write-Host "✅ RustDesk installation log found!"
            } else {
              Write-Host "⚠️ No log file found! RustDesk might still be installed."
            }
          } else {
            Write-Host "❌ RustDesk installer not found!"
            exit 1
          }
        shell: pwsh

      - name: Check if RustDesk is Running
        run: |
          if (Get-Process -Name "rustdesk" -ErrorAction SilentlyContinue) {
            Write-Host "✅ RustDesk is running."
          } else {
            Write-Host "❌ RustDesk is NOT running!"
            exit 1
          }
        shell: pwsh

      - name: Find RustDesk Installation Log
        run: |
          $logPaths = @(
            "${{ github.workspace }}\rustdesk_install.log",
            "C:\ProgramData\rustdesk_install.log",
            "C:\Users\runneradmin\AppData\Local\rustdesk_install.log"
          )

          foreach ($path in $logPaths) {
            if (Test-Path $path) {
              Write-Host "✅ Found log at: $path"
              Get-Content $path
              exit 0
            }
          }

          Write-Host "❌ No log file found!"
        shell: pwsh
