name: setup-windows-server

on: [push, pull_request]

jobs:
  setup-windows-server:
    runs-on: windows-latest

    steps:
      - name: Check out Repository
        uses: actions/checkout@v3

      - name: Verify Python Installation
        run: python --version
        shell: bash

      - name: Install RustDesk from Repo
        run: |
          $installerPath = "${{ github.workspace }}\rustdesk-1.3.8-x86_64.exe"
          if (Test-Path $installerPath) {
            Write-Host "✅ RustDesk installer found! Installing..."
            $process = Start-Process -FilePath $installerPath -ArgumentList "/VERYSILENT /SUPPRESSMSGBOXES /NORESTART /LOG=rustdesk_install.log" -NoNewWindow -PassThru
            $process | Wait-Process -Timeout 120 -ErrorAction SilentlyContinue
            if ($process.HasExited) {
              Write-Host "✅ RustDesk installed successfully!"
            } else {
              Write-Host "❌ RustDesk installation stuck! Killing process..."
              Stop-Process -Id $process.Id -Force
              exit 1
            }
          } else {
            Write-Host "❌ RustDesk installer not found!"
            exit 1
          }
        shell: pwsh

      - name: Check if RustDesk is Running
        run: |
          if (Get-Process -Name "rustdesk" -ErrorAction SilentlyContinue) {
            Write-Host "✅ RustDesk is running."
          } else {
            Write-Host "❌ RustDesk is NOT running!"
            exit 1
          }
        shell: pwsh

      - name: Show RustDesk Installation Logs
        run: cat rustdesk_install.log
        shell: bash

